---
title: TCP的流量控制与拥塞控制
categories: 网络
mathjax: true
tags:
  - TCP/IP
  - 流量控制
  - 拥塞控制
abbrlink: 6e65f3c1
date: 2024-04-12 22:02:01
---

## 流量控制（滑动窗口）

TCP 通过 **<u>滑动窗口机制</u>** 防止接收方处理数据的速度跟不上发送方，避免随着时间推移，数据自然溢出接收方的缓冲区。

### 发送端

发送方会建立自己的滑动窗口，按三个标准划分：是否发送、是否收到 ACK、是否在接收方通告处理范围内。

![](https://cdn.jsdelivr.net/gh/Euler0525/tube@master/net/sendwindow.webp)

1. 已经发送并且收到 `ACK` 的部分，已经成功发送，不需要在缓冲区保留；
2. 已经发送但未收到 `ACK`；
3. **可用窗口**：还没有发送，但是还在接收方窗口处理范围内（第二、三部分为整个 **发送窗口**）；

> `可用窗口大小=SND.WND+SND.UNA-SND.NXT`
>
> - SND.WND：发送窗口，32-51
>
> - SND.UNA：指针，指向已发送未确认的字节，如上图 `SND.UNA=32`
>
> - SND.NXT：可用窗口的第一个字节，如上图 `SND.NXT=46`

4. 需要发送，但是超过接收方窗口范围的部分。在没有收到新的 `ACK` 之前，发送方不会发送这些数据，通过这个限制，发送的数据就不会超过接收方缓冲区；

> 如果 `ACK` 在网络传输中丢包，发送端就不会感知到接收端窗口的变化，发送方一直没有收到 `ACK`，随着数据不断发送，可用窗口会被占满，发送方认为接收端处于零窗口状态，就不会继续发送数据，接收端也一直在等待发送端发送数据，进入了死锁状态。
>
> 解决办法：引入零窗口计时器，如果发送端陷入零窗口状态，就启动计时器，定时询问接收端窗口是否可用。

随着 `ACK` 或进程读取数据，窗口会顺次后移。如果接收到 `ACK`，表示之前的数据都收到了，那么可用窗口就会顺次右移

![](https://cdn.jsdelivr.net/gh/Euler0525/tube@master/net/slidewindow.webp)

### 接收端

接收端的窗口分为已经接收并确认的区域、未收到但是可以接收的区域（接收窗口），剩下的是不可接收的区域。

![](https://cdn.jsdelivr.net/gh/Euler0525/tube@master/net/receivewindow.webp)

**如果进程读取缓冲区的速度有变化，接受端就会相应调整接收窗口的大小，并告诉发送端，就可以控制发送端的发送速度**。

## 拥塞控制

在实际网络中，由于大量的包传输，可能导致中间某些节点的缓冲区满载，多余的包被丢弃，需要重新发送，最差的情况，网络上的包都是重传的包并且被反复丢弃，整个网络的传输能力降为 0.

TCP 协议使用 **<u>拥塞窗口机制</u>** 解决这个问题。当节点发现自己的部分包丢的时候，有理由怀疑网络发生了拥塞，大部分节点会减少自己传输的包，这样网络拥塞环境就会得到缓解。在发送端定义一个窗口 **CWND(congestion window)**，**发送端最大的发送范围** 是拥塞窗口和滑动窗口中较小的一个。

拥塞窗口的大小动态地随着网络情况调整，拥塞控制算法主要包括四个部分：

![](https://cdn.jsdelivr.net/gh/Euler0525/tube@master/net/congestion.webp)

- 慢启动：在不确定拥塞是否会发生的情况下，会采用倍增的方式逐渐增加窗口的大小；
- 拥塞避免：在窗口增加到一定程度时，减缓增加的速度，转为线性扩大窗口的方式（每次收到 ACK 没有丢包的情况下只比上次窗口增大 1）；
- 拥塞发生：当网络遇到丢包的情况，一方面进行<u>超时重传</u>或<u>快速重传</u>，另一方面缩小窗口的范围；
- 快速恢复
  - 快速重传：如果连续 3 次收到重复的 ACK，说明部分丢包，这时采用快速恢复（拥塞窗口变为原来的一半，ssthresh 设置成当前窗口大小，再执行拥塞避免算法。有时会设置 `CWND=ssthresh+3`）；
    - 超时重传：拥塞比较严重，直接将 ssthresh 设置为原来的一半，窗口重置为 1，再进入慢启动阶段；


> 两者区别（参考 AI 生成结果）
>
> 流量控制主要是控制发送方发送数据的速率，以避免接收方来不及处理接收到的数据，造成数据的丢失。流量控制是一种 **端到端** 的控制机制，它确保发送方的发送速率与接收方的处理能力相匹配。在 TCP 协议中，流量控制是通过滑动窗口机制实现的，接收方通过返回的 ACK 中包含的窗口大小来告诉发送方自己的接收能力（基于反馈进行控制）。
>
> 拥塞控制则是防止过多的数据注入到网络中，从而使网络中的路由器或链路不会过载。拥塞控制是一种全局性的控制机制，它关注的是整个网络的运行状态，而不仅仅是两个端点之间的通信。TCP 协议中的拥塞控制是通过慢启动、拥塞避免、快速重传和快速恢复等算法来实现的，这些算法根据网络的拥塞程度来调整数据传输的速率。
>
> 总结：流量控制是为了让发送方的发送速率与接收方的处理能力相匹配，是 **局部性过程** 的而拥塞控制是为了让整个网络的数据传输量处于网络可以处理的范围内，是 **全局性过程**。
>
> 数据链路层的流量控制是 **点对点** 的，数据链路层流量控制的手段是接收方收不下就不回复确认帧。传输层的流量控制手段是接收端通过滑动窗口告诉发送方。

## 参考资料

1. [滑动窗口：TCP 是如何进行流量控制和拥塞控制的？](https://time.geekbang.org/column/article/482065)
1. [TCP Sliding Window Data Transfer and Acknowledgement Mechanics](http://www.tcpipguide.com/free/t_TCPSlidingWindowDataTransferandAcknowledgementMech-5.htm)
1. [传输层&数据链路层流量控制](https://blog.csdn.net/qq_43212582/article/details/123413278#:~:text=%EF%BC%881%EF%BC%89%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%98%AF%E7%82%B9%E5%AF%B9%E7%82%B9%E7%9A%84%EF%BC%8C%E8%80%8C%E4%BC%A0%E8%BE%93%E5%B1%82%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%98%AF%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%9A%84%E3%80%82%20%EF%BC%882%EF%BC%89%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E6%89%8B%E6%AE%B5%E6%98%AF%E6%8E%A5%E6%94%B6%E6%96%B9%E6%94%B6%E4%B8%8D%E4%B8%8B%E5%B0%B1%E4%B8%8D%E5%9B%9E%E5%A4%8D%E7%A1%AE%E8%AE%A4%E5%B8%A7%E3%80%82%20%E4%BC%A0%E8%BE%93%E5%B1%82%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%89%8B%E6%AE%B5%E6%98%AF%E6%8E%A5%E6%94%B6%E7%AB%AF%E9%80%9A%E8%BF%87%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%91%8A%E8%AF%89%E5%8F%91%E9%80%81%E6%96%B9%E3%80%82%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%96%B9%E6%B3%95%E4%B8%BB%E8%A6%81%E6%98%AF%E5%81%9C%E6%AD%A2%E7%AD%89%E5%BE%85%E5%8D%8F%E8%AE%AE%E5%92%8C%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%8D%8F%E8%AE%AE%EF%BC%8C%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%8D%8F%E8%AE%AE%E8%BF%98%E5%8C%85%E6%8B%AC%E5%90%8E%E9%80%80N%E5%B8%A7%E5%8D%8F%E8%AE%AEGBN%E5%92%8C%E9%80%89%E6%8B%A9%E9%87%8D%E5%8D%8F%E8%AE%AESR%E3%80%82,%E5%81%9C%E6%AD%A2%E7%AD%89%E5%BE%85%E5%8D%8F%E8%AE%AE%20%E5%B0%B1%E6%98%AF%E6%AF%8F%E5%8F%91%E9%80%81%E5%AE%8C%E4%B8%80%E4%B8%AA%E5%B8%A7%E5%B0%B1%E5%81%9C%E6%AD%A2%E5%8F%91%E9%80%81%EF%BC%8C%E7%AD%89%E5%BE%85%E5%AF%B9%E6%96%B9%E7%9A%84%E7%A1%AE%E8%AE%A4%E5%B8%A7%EF%BC%8C%E5%9C%A8%E6%94%B6%E5%88%B0%E7%A1%AE%E8%AE%A4%E5%B8%A7%E5%90%8E%E5%86%8D%E5%8F%91%E9%80%81%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%B8%A7%E3%80%82%20%E5%90%8E%E9%80%80N%E5%B8%A7%E5%8D%8F%E8%AE%AE%20%E7%9B%B8%E6%AF%94%E4%BA%8E%E5%81%9C%E6%AD%A2%E7%AD%89%E5%BE%85%E5%8D%8F%E8%AE%AE%EF%BC%8C%E5%AE%83%E4%B8%8D%E9%9C%80%E8%A6%81%E7%AD%89%E5%BE%85%E5%89%8D%E4%B8%80%E4%B8%AA%E5%B8%A7%E7%9A%84%E7%A1%AE%E8%AE%A4%E5%B8%A7%E4%BE%BF%E5%8F%AF%E5%8F%91%E9%80%81%E5%90%8E%E9%9D%A2%E7%9A%84%E5%B8%A7%EF%BC%8C%E4%B9%8B%E6%89%80%E4%BB%A5%E6%98%AF%E5%8F%AB%E5%90%8E%E9%80%80N%E5%B8%A7%EF%BC%8C%E6%98%AF%E5%BD%93%E6%9C%89%E4%B8%80%E4%B8%AA%E5%B8%A7x%E5%8F%91%E9%80%81%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%AF%9D%EF%BC%8Cx%E4%B9%8B%E5%90%8E%E7%9A%84%E6%89%80%E6%9C%89%E5%B8%A7%E9%83%BD%E9%9C%80%E8%A6%81%E9%87%8D%E4%BC%A0%E3%80%82)
